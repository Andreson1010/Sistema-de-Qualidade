# Projeto 6 — Versionamento e Controle de Dados em Pipelines CI/CD com GitHub Actions e Kubernetes

Este guia descreve como preparar o ambiente, treinar o modelo, construir a imagem Docker, publicar e acessar no Minikube e validar o pipeline CI/CD localmente com Act.

## Pré‑requisitos

- Docker Desktop instalado e em execução (mantenha a janela aberta)
- Kubectl instalado
- Minikube instalado
- Conda (ou Miniconda) instalado
- Git instalado
- Act instalado para testar GitHub Actions localmente

Validações rápidas:

```bash
kubectl version --client
minikube version
```

Links úteis: [Git](https://git-scm.com/) · [Act](https://nektosact.com/installation/index.html)

## Configuração do ambiente Python

Crie e ative o ambiente virtual, depois instale dependências:

```bash
conda create --name pipep6 python=3.12
conda activate pipep6  # em bash/zsh; no Windows PowerShell: conda activate pipep6
conda install pip
pip install -r requirements.txt
```

## Treinamento do modelo

Treine e salve a versão inicial do modelo localmente:

```bash
python treinamento/aivk_treina_modelo.py
```

## Build da imagem Docker

Certifique-se de que o Docker Desktop está ativo. Construa a imagem:

```bash
docker build -t aivk-p6-app:latest .
```

Observação (Apple Silicon): ao usar Act, pode ser necessário forçar `linux/amd64`.

## Minikube e contexto Kubernetes

Inicie o cluster sempre que ligar a máquina e confirme o contexto do kubectl:

```bash
minikube start
kubectl config current-context  # deve retornar "minikube"
```

Carregue a imagem Docker local no registro do Minikube:

```bash
minikube image load dsa-p6-app:latest
```

## Deploy no Kubernetes

Aplicar os manifestos e validar recursos:

```bash
kubectl apply -f k8s/deployment.yaml
kubectl apply -f k8s/service.yaml
kubectl get pods
```

Acesse a aplicação via serviço do Minikube:

```bash
minikube service dsa-p6-app-service
```

## Git e inicialização do repositório

Em um novo terminal, inicialize o repositório e faça o primeiro commit:

```bash
git config --global user.email "aluno@teste.com"
git config --global user.name "Aluno DSA"
git init
git add .
git commit -m "Versão inicial do Projeto DSA"
```

## Teste do CI/CD local com Act

Execute o fluxo localmente para simular um push:

```bash
act push
```

Em Apple Silicon (Família M), use:

```bash
act push --container-architecture linux/amd64
```

## Ciclo de atualização

Quando alterar o script de treinamento, app ou dados:

```bash
git add .
git commit -m "Atualização do projeto"
act push
```

Para atualizar a imagem no cluster local em tempo real:

```bash
minikube image load dsa-p6-app:latest
kubectl set image deployment/dsa-p6-app-deployment dsa-p6-app-container=dsa-p6-app:latest
```

## Dicas de verificação e diagnóstico (troubleshooting)

- Pods com erro (CrashLoopBackOff):
  ```bash
  kubectl get pods
  kubectl describe pod <nome-do-pod>
  kubectl logs <nome-do-pod>
  ```
- Imagem não encontrada: garanta `minikube image load dsa-p6-app:latest` antes do deploy ou da atualização
- Contexto incorreto do kubectl: verifique com `kubectl config current-context`
- Docker parado: abra o Docker Desktop e aguarde inicialização

## Limpeza (opcional)

Desative e remova o ambiente Conda:

```bash
conda deactivate
conda remove --name pipep6 --all
```